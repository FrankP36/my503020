<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Budget Planner — Live FX + 50/30/20</title>
<style>
  :root {
    --bg: #0b1220;
    --card: #0f172a;
    --muted: #94a3b8;
    --text: #e5e7eb;
    --accent: #22c55e;
    --warn: #f59e0b;
    --danger: #ef4444;
    --input: #111827;
    --ring: #2563eb33;
    --blue: #2563eb;
    --grid: #1f2937;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, Noto Sans;
    background: linear-gradient(180deg, #081022, var(--bg));
    color: var(--text);
    min-height: 100vh;
    display: grid;
    place-items: start center;
    padding: 14px;
  }
  .wrap { width: 100%; max-width: 1100px; display: grid; gap: 14px; }
  header { display: grid; gap: 6px; text-align: center; }
  header h1 { margin: 0; font-size: clamp(20px, 3.6vw, 30px); }
  header p { margin: 0; color: var(--muted); font-size: 14px; }
  .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
  @media (min-width: 980px) { .grid { grid-template-columns: 1.05fr 1fr; } }
  .card { background: linear-gradient(180deg, #0d152a, var(--card)); border: 1px solid var(--grid); border-radius: 14px; padding: 14px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
  .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 700; }
  .subtle { color: var(--muted); font-size: 12px; }
  .pill { display: inline-flex; gap: 6px; align-items: center; padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #334155; color: var(--muted); background: #0b1324; }
  label { color: var(--muted); font-size: 13px; }
  .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
  .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .input, select, .btn, textarea { background: var(--input); color: var(--text); border: 1px solid #374151; border-radius: 10px; padding: 10px 12px; outline: none; font-size: 14px; }
  .input { display: flex; align-items: center; gap: 8px; }
  .input:focus-within, select:focus, textarea:focus { border-color: var(--blue); box-shadow: 0 0 0 4px var(--ring); }
  .input input[type="number"], .input input[type="text"] { flex: 1; background: transparent; border: none; color: var(--text); font-size: 15px; min-width: 0; outline: none; -moz-appearance: textfield; }
  .input input::-webkit-outer-spin-button, .input input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .btn { cursor: pointer; font-weight: 700; transition: background 0.2s, color 0.2s; }
  .btn:hover { opacity: 0.85; }
  .btn.primary { background: var(--blue); border-color: var(--blue); color: #fff; }
  .btn.ghost { background: transparent; border-color: #334155; color: var(--text); }
  .btn.warn { background: #3b2d09; border-color: #6b4b0b; color: #fbbf24; }
  .cols-3 { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 720px) { .cols-3 { grid-template-columns: repeat(3, 1fr); } }
  .stat { display: grid; gap: 4px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--grid); background: #0b1428; }
  .stat .label { color: var(--muted); font-size: 12px; }
  .stat .value { font-weight: 800; font-size: 18px; }
  .value.positive { color: var(--accent); }
  .value.warn { color: var(--warn); }
  .value.negative { color: var(--danger); }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th, td { padding: 6px 8px; border-bottom: 1px solid var(--grid); vertical-align: middle; }
  th { text-align: left; color: var(--muted); font-weight: 700; }
  .row-actions { display: flex; gap: 6px; }
  canvas { width: 100%; height: auto; max-height: 300px; display: block; }
  .goal { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; border: 1px solid var(--grid); padding: 10px; border-radius: 10px; background: #0a1426; }
  .progress { height: 8px; background: #1f2937; border-radius: 999px; overflow: hidden; }
  .progress > span { display: block; height: 100%; background: var(--accent); }
  .tip { background: #0a1a33; border: 1px dashed #26427a; padding: 10px; border-radius: 10px; color: #c7d2fe; font-size: 13px; }
  .small { font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Smart Budget Planner</h1>
    <p>Live FX (Exchangerate.host), 50/30/20 auto allocation, expense tracking, charts, goals, and smart tips.</p>
  </header>

  <div class="grid">
    <!-- Left: Inputs and Tracking -->
    <section class="card">
      <div class="section-title">
        <span>Settings</span>
        <span class="pill" id="periodPill">Monthly</span>
      </div>

      <div class="flex" style="justify-content: space-between;">
        <div class="flex" style="gap:12px;">
          <div class="flex">
            <label for="currency" class="subtle">Currency</label>
            <select id="currency" title="Display currency">
              <option value="USD" selected>USD $</option>
              <option value="EUR">EUR €</option>
              <option value="GBP">GBP £</option>
              <option value="JPY">JPY ¥</option>
              <option value="CAD">CAD $</option>
              <option value="AUD">AUD $</option>
              <option value="INR">INR ₹</option>
              <option value="NGN">NGN ₦</option>
              <option value="ZAR">ZAR R</option>
              <option value="KES">KES KSh</option>
              <option value="TZS">TZS TSh</option>
              <option value="UGX">UGX USh</option>
            </select>
          </div>
          <div class="flex">
            <label for="period" class="subtle">Period</label>
            <select id="period" title="Monthly or Annual">
              <option value="monthly" selected>Monthly</option>
              <option value="annual">Annual</option>
            </select>
          </div>
        </div>
        <div class="flex">
          <button id="share" class="btn">Copy Snapshot</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label for="income">Income (enter amount)</label>
        <div class="input"><span id="curSymbol1">$</span><input id="income" type="number" min="0" step="1" value="3500" /></div>
      </div>
      <p class="small">Choose Monthly/Annual above. The app will allocate 50/30/20 targets from your income automatically.</p>

      <div class="section-title" style="margin-top:10px;">
        <span>Expense Tracking</span>
        <span class="subtle">Log actual spending and compare to ideal limits.</span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:34%;">Name</th>
            <th style="width:16%;">Type</th>
            <th style="width:20%;">Planned</th>
            <th style="width:20%;">Actual</th>
            <th style="width:10%;">Actions</th>
          </tr>
        </thead>
        <tbody id="expBody"></tbody>
      </table>

      <div class="flex" style="margin-top:8px;">
        <button id="addRow" class="btn ghost">+ Add Item</button>
        <button id="reset" class="btn">Reset to Example</button>
      </div>

      <div class="section-title" style="margin-top:14px;">
        <span>Goals</span>
        <span class="subtle">Set savings goals and track progress.</span>
      </div>

      <div id="goals"></div>
      <div class="flex" style="margin-top:8px;">
        <input id="goalName" class="input" style="flex:2;" placeholder="Goal name (e.g., Emergency Fund)" />
        <input id="goalTarget" class="input" type="number" min="0" step="1" style="flex:1;" placeholder="Target amount" />
        <input id="goalDate" class="input" type="date" style="flex:1;" />
        <button id="addGoal" class="btn primary">Add Goal</button>
      </div>

      <p class="small" id="fxStatus" style="margin-top:8px;"></p>
    </section>

    <!-- Right: Results, Charts, Report -->
    <section class="card">
      <div class="section-title"><span>Overview</span></div>

      <div class="cols-3">
        <div class="stat">
          <div class="label" id="incomeLabel">Income (Monthly)</div>
          <div class="value" id="incomeVal">$3,500</div>
        </div>
        <div class="stat">
          <div class="label">Planned total</div>
          <div class="value" id="plannedVal">$0</div>
        </div>
        <div class="stat">
          <div class="label">Actual total</div>
          <div class="value" id="actualVal">$0</div>
        </div>
      </div>

      <div class="cols-3" style="margin-top:8px;">
        <div class="stat">
          <div class="label">Needs (target)</div>
          <div class="value" id="needsTarget">$0</div>
          <div class="label">Actual</div>
          <div class="value" id="needsActual">$0</div>
        </div>
        <div class="stat">
          <div class="label">Wants (target)</div>
          <div class="value" id="wantsTarget">$0</div>
          <div class="label">Actual</div>
          <div class="value" id="wantsActual">$0</div>
        </div>
        <div class="stat">
          <div class="label">Savings/Debt (target)</div>
          <div class="value" id="savingsTarget">$0</div>
          <div class="label">Actual</div>
          <div class="value" id="savingsActual">$0</div>
        </div>
      </div>

      <div class="cols-3" style="margin-top:8px;">
        <div class="stat">
          <div class="label">Remaining vs Planned</div>
          <div class="value" id="remainPlanned">$0</div>
        </div>
        <div class="stat">
          <div class="label">Remaining vs Actual</div>
          <div class="value" id="remainActual">$0</div>
        </div>
        <div class="stat">
          <div class="label">Savings rate (actual)</div>
          <div class="value" id="savingsRate">—</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:8px;">
        <span>Charts</span>
        <div class="flex">
          <button id="toggleChart" class="btn ghost">Toggle Pie/Bar</button>
        </div>
      </div>
      <canvas id="chart" height="220"></canvas>

      <div class="section-title" style="margin-top:8px;"><span>Monthly Summary Report</span></div>
      <div id="report" class="tip"></div>

      <div class="section-title" style="margin-top:8px;"><span>Smart Tips</span></div>
      <div id="tips" class="tip"></div>
    </section>
  </div>
</div>

<script>
(function(){
  // Config
  const ACCESS_KEY = "9493bcb259a7b5da0d1ec8f7287d9fc7"; // provided
  const FX_URL = `https://api.exchangerate.host/latest?base=USD&access_key=${encodeURIComponent(ACCESS_KEY)}`;
  const LS_FX = "sbp_fx_v1";
  const LS_FX_TIME = "sbp_fx_time_v1";
  const LS_STATE = "sbp_state_v1";
  const LS_GOALS = "sbp_goals_v1";

  // Currency symbols
  const CUR = {
    USD:"$", EUR:"€", GBP:"£", JPY:"¥", CAD:"$", AUD:"$", INR:"₹", NGN:"₦", ZAR:"R",
    KES:"KSh", TZS:"TSh", UGX:"USh"
  };

  // Initial FX fallback
  let FX = {
    USD: 1, EUR: 0.93, GBP: 0.81, JPY: 153, CAD: 1.38, AUD: 1.52,
    INR: 84, NGN: 1600, ZAR: 18.5, KES: 129, TZS: 2590, UGX: 3800
  };

  // Restore FX
  try {
    const saved = JSON.parse(localStorage.getItem(LS_FX) || "null");
    if (saved) FX = { ...FX, ...saved };
  } catch {}

  // Elements
  const $ = (id) => document.getElementById(id);
  const els = {
    currency: $("currency"),
    period: $("period"),
    periodPill: $("periodPill"),
    income: $("income"),
    curSymbol1: $("curSymbol1"),
    expBody: $("expBody"),
    addRow: $("addRow"),
    reset: $("reset"),
    share: $("share"),
    incomeLabel: $("incomeLabel"),
    incomeVal: $("incomeVal"),
    plannedVal: $("plannedVal"),
    actualVal: $("actualVal"),
    needsTarget: $("needsTarget"),
    wantsTarget: $("wantsTarget"),
    savingsTarget: $("savingsTarget"),
    needsActual: $("needsActual"),
    wantsActual: $("wantsActual"),
    savingsActual: $("savingsActual"),
    remainPlanned: $("remainPlanned"),
    remainActual: $("remainActual"),
    savingsRate: $("savingsRate"),
    chart: $("chart"),
    report: $("report"),
    tips: $("tips"),
    fxStatus: $("fxStatus"),
    toggleChart: $("toggleChart"),
    // Goals
    goalsWrap: $("goals"),
    goalName: $("goalName"),
    goalTarget: $("goalTarget"),
    goalDate: $("goalDate"),
    addGoal: $("addGoal"),
  };

  // State
  let state = {
    currency: "USD",
    period: "monthly", // monthly | annual
    incomeUSDMonthly: 3500, // stored in USD per month internally
    rows: [
      // { id, name, type: 'Needs'|'Wants'|'Savings', plannedUSDMonthly, actualUSDMonthly }
    ],
  };

  // Restore state
  try {
    const saved = JSON.parse(localStorage.getItem(LS_STATE) || "null");
    if (saved) state = { ...state, ...saved, rows: Array.isArray(saved.rows) ? saved.rows : [] };
  } catch {}

  // Goals
  let goals = [];
  try {
    const savedG = JSON.parse(localStorage.getItem(LS_GOALS) || "null");
    if (Array.isArray(savedG)) goals = savedG;
  } catch {}

  // Helpers
  const toUSD = (amountDisplay) => {
    const rate = FX[state.currency] || 1;
    return (amountDisplay || 0) / rate;
  };
  const fromUSD = (amountUSD) => {
    const rate = FX[state.currency] || 1;
    return (amountUSD || 0) * rate;
  };
  const fmt = (n) => {
    try {
      return n.toLocaleString(undefined, { style: "currency", currency: state.currency, maximumFractionDigits: 0, minimumFractionDigits: 0 });
    } catch {
      const sym = CUR[state.currency] || "";
      return `${sym}${Math.round(n).toLocaleString()}`;
    }
  };
  const periodFactor = () => state.period === "annual" ? 12 : 1;

  // FX update
  async function updateFX() {
    let ok = false;
    try {
      const resp = await fetch(FX_URL, { cache: "no-store" });
      const data = await resp.json();
      if (data && data.rates && data.rates.USD === 1) {
        FX = {
          USD: 1,
          EUR: data.rates.EUR ?? FX.EUR,
          GBP: data.rates.GBP ?? FX.GBP,
          JPY: data.rates.JPY ?? FX.JPY,
          CAD: data.rates.CAD ?? FX.CAD,
          AUD: data.rates.AUD ?? FX.AUD,
          INR: data.rates.INR ?? FX.INR,
          NGN: data.rates.NGN ?? FX.NGN,
          ZAR: data.rates.ZAR ?? FX.ZAR,
          KES: data.rates.KES ?? FX.KES,
          TZS: data.rates.TZS ?? FX.TZS,
          UGX: data.rates.UGX ?? FX.UGX,
        };
        ok = true;
        localStorage.setItem(LS_FX, JSON.stringify(FX));
        localStorage.setItem(LS_FX_TIME, String(Date.now()));
      } else if (data && data.success === false) {
        console.warn("FX API error:", data.error || data);
      }
    } catch (e) {
      console.warn("FX fetch failed:", e);
    }
    const last = Number(localStorage.getItem(LS_FX_TIME) || 0);
    const agoMin = last ? Math.round((Date.now() - last) / 60000) : null;
    els.fxStatus.textContent = ok
      ? "Live FX updated from Exchangerate.host."
      : last
        ? `Using cached FX from ${agoMin} min ago.`
        : "Using sample FX (live unavailable).";
    syncCurrencyUI();
    compute();
  }

  // Expense rows UI
  function renderRows() {
    els.expBody.innerHTML = "";
    for (const r of state.rows) {
      addRowUI(r);
    }
  }

  function addRowUI(row) {
    const tr = document.createElement("tr");
    tr.dataset.id = row.id;

    // Name
    const tdName = document.createElement("td");
    const nameWrap = document.createElement("div"); nameWrap.className = "input";
    const nameInput = document.createElement("input"); nameInput.type = "text"; nameInput.placeholder = "e.g., Rent, Groceries";
    nameInput.value = row.name || "";
    nameWrap.appendChild(nameInput);
    tdName.appendChild(nameWrap);

    // Type
    const tdType = document.createElement("td");
    const typeSel = document.createElement("select");
    ["Needs","Wants","Savings"].forEach(t => {
      const o = document.createElement("option"); o.value = t; o.textContent = t;
      if (row.type === t) o.selected = true;
      typeSel.appendChild(o);
    });
    tdType.appendChild(typeSel);

    // Planned
    const tdPlanned = document.createElement("td");
    const pWrap = document.createElement("div"); pWrap.className = "input";
    const pSym = document.createElement("span"); pSym.textContent = CUR[state.currency] || "$";
    const pInput = document.createElement("input"); pInput.type = "number"; pInput.min = "0"; pInput.step = "1";
    pInput.value = Math.round(fromUSD(row.plannedUSDMonthly * periodFactor() / (state.period === "annual" ? 12 : 1)));
    pWrap.appendChild(pSym); pWrap.appendChild(pInput); tdPlanned.appendChild(pWrap);

    // Actual
    const tdActual = document.createElement("td");
    const aWrap = document.createElement("div"); aWrap.className = "input";
    const aSym = document.createElement("span"); aSym.textContent = CUR[state.currency] || "$";
    const aInput = document.createElement("input"); aInput.type = "number"; aInput.min = "0"; aInput.step = "1";
    aInput.value = Math.round(fromUSD(row.actualUSDMonthly * periodFactor() / (state.period === "annual" ? 12 : 1)));
    aWrap.appendChild(aSym); aWrap.appendChild(aInput); tdActual.appendChild(aWrap);

    // Actions
    const tdAct = document.createElement("td");
    const act = document.createElement("div"); act.className = "row-actions";
    const delBtn = document.createElement("button"); delBtn.className = "btn"; delBtn.textContent = "Delete";
    delBtn.addEventListener("click", () => {
      state.rows = state.rows.filter(r => r.id !== row.id);
      saveState();
      renderRows();
      compute();
    });
    act.appendChild(delBtn); tdAct.appendChild(act);

    tr.appendChild(tdName);
    tr.appendChild(tdType);
    tr.appendChild(tdPlanned);
    tr.appendChild(tdActual);
    tr.appendChild(tdAct);
    els.expBody.appendChild(tr);

    // Bindings
    const syncRow = () => {
      row.name = nameInput.value.trim();
      row.type = typeSel.value;
      // Inputs are in display currency, for current period; convert to USD monthly storage.
      const plannedDisp = +pInput.value || 0;
      const actualDisp = +aInput.value || 0;
      const toMonthlyUSD = (disp) => {
        const usdPeriod = toUSD(disp);
        return state.period === "annual" ? (usdPeriod / 12) : usdPeriod;
      };
      row.plannedUSDMonthly = toMonthlyUSD(plannedDisp);
      row.actualUSDMonthly = toMonthlyUSD(actualDisp);
      saveState();
      compute();
    };
    nameInput.addEventListener("input", syncRow);
    typeSel.addEventListener("change", syncRow);
    pInput.addEventListener("input", syncRow);
    aInput.addEventListener("input", syncRow);
  }

  // Add row button
  els.addRow.addEventListener("click", () => {
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
    const newRow = { id, name: "", type: "Needs", plannedUSDMonthly: 0, actualUSDMonthly: 0 };
    state.rows.push(newRow);
    saveState();
    addRowUI(newRow);
    compute();
  });

  // Reset example
  els.reset.addEventListener("click", () => {
    state.currency = "USD";
    els.currency.value = "USD";
    state.period = "monthly";
    els.period.value = "monthly";
    els.periodPill.textContent = "Monthly";
    els.income.value = 3500;
    state.incomeUSDMonthly = 3500;
    state.rows = [
      { id: "r1", name: "Housing (Rent)", type: "Needs", plannedUSDMonthly: 1200, actualUSDMonthly: 1200 },
      { id: "r2", name: "Groceries", type: "Needs", plannedUSDMonthly: 400, actualUSDMonthly: 420 },
      { id: "r3", name: "Transport", type: "Needs", plannedUSDMonthly: 220, actualUSDMonthly: 180 },
      { id: "r4", name: "Entertainment", type: "Wants", plannedUSDMonthly: 200, actualUSDMonthly: 260 },
      { id: "r5", name: "Dining Out", type: "Wants", plannedUSDMonthly: 150, actualUSDMonthly: 180 },
      { id: "r6", name: "Savings/Investments", type: "Savings", plannedUSDMonthly: 500, actualUSDMonthly: 500 },
    ];
    saveState();
    renderRows();
    syncCurrencyUI();
    compute();
  });

  // Period and currency
  els.period.addEventListener("change", () => {
    state.period = els.period.value;
    els.periodPill.textContent = state.period === "monthly" ? "Monthly" : "Annual";
    // Re-render inputs to reflect period unit change
    renderRows();
    compute();
    saveState();
  });

  els.currency.addEventListener("change", () => {
    state.currency = els.currency.value;
    syncCurrencyUI();
    // Re-render amounts for new currency symbol
    renderRows();
    compute();
    saveState();
  });

  // Income input
  els.income.addEventListener("input", () => {
    const disp = +els.income.value || 0;
    const usdPeriod = toUSD(disp);
    state.incomeUSDMonthly = state.period === "annual" ? (usdPeriod / 12) : usdPeriod;
    saveState();
    compute();
  });

  // Share snapshot
  els.share.addEventListener("click", async () => {
    const pf = periodFactor();
    const incomePeriod = fromUSD(state.incomeUSDMonthly * pf);
    const targets = getTargetsUSD(); // monthly USD
    const lines = [
      "Smart Budget Snapshot",
      "---------------------",
      `Currency: ${state.currency}`,
      `Period: ${state.period}`,
      `Income: ${fmt(incomePeriod)}`,
      "",
      "Items:"
    ];
    for (const r of state.rows) {
      const p = fromUSD(r.plannedUSDMonthly * pf);
      const a = fromUSD(r.actualUSDMonthly * pf);
      lines.push(`- ${r.name || "Untitled"} [${r.type}] Planned: ${fmt(p)} | Actual: ${fmt(a)}`);
    }
    lines.push("");
    lines.push(`Targets — Needs: ${fmt(fromUSD(targets.needsUSDMonthly * pf))}, Wants: ${fmt(fromUSD(targets.wantsUSDMonthly * pf))}, Savings: ${fmt(fromUSD(targets.savingsUSDMonthly * pf))}`);
    lines.push("");
    lines.push(...generateReportLines());
    try {
      await navigator.clipboard.writeText(lines.join("\n"));
      const txt = els.share.textContent;
      els.share.textContent = "Copied!";
      setTimeout(()=> els.share.textContent = txt, 1500);
    } catch {
      alert(lines.join("\n"));
    }
  });

  // Goals
  function renderGoals() {
    els.goalsWrap.innerHTML = "";
    const incomeMonthlyUSD = state.incomeUSDMonthly;
    const monthlySavingsActualUSD = sumByType("Savings", "actualUSDMonthly");
    for (const g of goals) {
      const div = document.createElement("div");
      div.className = "goal";
      const info = document.createElement("div");
      const title = document.createElement("div");
      title.style.fontWeight = "800";
      title.textContent = `${g.name} — Target: ${fmt(fromUSD(g.targetUSD))} by ${g.date || "—"}`;
      const savedDisp = fmt(fromUSD(g.savedUSD));
      const remainUSD = Math.max(0, g.targetUSD - g.savedUSD);
      const remainDisp = fmt(fromUSD(remainUSD));
      const monthlyAddDisp = fmt(fromUSD(monthlySavingsActualUSD));
      const eta = estimateETA(remainUSD, monthlySavingsActualUSD, g.date);
      const small = document.createElement("div");
      small.className = "small";
      small.textContent = `Saved: ${savedDisp} | Remaining: ${remainDisp} | Current monthly savings: ${monthlyAddDisp} ${eta ? "| ETA: " + eta : ""}`;
      info.appendChild(title); info.appendChild(small);

      const controls = document.createElement("div");
      controls.className = "flex";
      const addAmt = document.createElement("input"); addAmt.className = "input"; addAmt.type="number"; addAmt.min="0"; addAmt.step="1"; addAmt.placeholder="Add amount";
      const addBtn = document.createElement("button"); addBtn.className="btn primary"; addBtn.textContent="Add";
      addBtn.addEventListener("click", () => {
        const disp = +addAmt.value || 0;
        const usd = toUSD(disp);
        g.savedUSD = Math.max(0, (g.savedUSD || 0) + usd);
        saveGoals();
        renderGoals();
      });
      const delBtn = document.createElement("button"); delBtn.className="btn"; delBtn.textContent="Delete";
      delBtn.addEventListener("click", () => {
        goals = goals.filter(x => x.id !== g.id);
        saveGoals();
        renderGoals();
      });
      controls.appendChild(addAmt); controls.appendChild(addBtn); controls.appendChild(delBtn);

      const progress = document.createElement("div"); progress.className="progress";
      const pct = g.targetUSD > 0 ? Math.min(100, Math.round(100 * (g.savedUSD || 0) / g.targetUSD)) : 0;
      const bar = document.createElement("span"); bar.style.width = pct + "%";
      progress.appendChild(bar);

      div.appendChild(info);
      div.appendChild(controls);
      div.appendChild(progress);
      els.goalsWrap.appendChild(div);
    }
  }

  function estimateETA(remainUSD, monthlyAddUSD, targetDateStr) {
    if (monthlyAddUSD <= 0 || remainUSD <= 0) return "";
    const months = Math.ceil(remainUSD / monthlyAddUSD);
    if (targetDateStr) {
      const targetDate = new Date(targetDateStr);
      const now = new Date();
      const diffMonths = Math.max(0, Math.round((targetDate - now) / (1000 * 60 * 60 * 24 * 30)));
      if (months <= diffMonths) return `on track (~${months} mo)`;
      return `needs +${fmt(fromUSD(Math.ceil(remainUSD / Math.max(1, diffMonths)) - monthlyAddUSD))}/mo to hit target date`;
    }
    return `~${months} months at current pace`;
  }

  els.addGoal.addEventListener("click", () => {
    const name = els.goalName.value.trim();
    const targetDisp = +els.goalTarget.value || 0;
    const date = els.goalDate.value || "";
    if (!name || targetDisp <= 0) {
      alert("Enter a goal name and target amount.");
      return;
    }
    const g = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
      name,
      targetUSD: toUSD(targetDisp),
      savedUSD: 0,
      date
    };
    goals.push(g);
    els.goalName.value = "";
    els.goalTarget.value = "";
    els.goalDate.value = "";
    saveGoals();
    renderGoals();
  });

  function saveState() {
    localStorage.setItem(LS_STATE, JSON.stringify(state));
  }
  function saveGoals() {
    localStorage.setItem(LS_GOALS, JSON.stringify(goals));
  }

  // Currency UI sync
  function syncCurrencyUI() {
    els.curSymbol1.textContent = CUR[state.currency] || "$";
    // Update symbols in table
    els.expBody.querySelectorAll("td:nth-child(3) .input span:first-child, td:nth-child(4) .input span:first-child")
      .forEach(s => s.textContent = CUR[state.currency] || "$");
  }

  // Targets (50/30/20) in USD monthly
  function getTargetsUSD() {
    const inc = state.incomeUSDMonthly;
    return {
      needsUSDMonthly: 0.50 * inc,
      wantsUSDMonthly: 0.30 * inc,
      savingsUSDMonthly: 0.20 * inc,
    };
  }

  // Sum helpers
  function sumByType(type, field) {
    return state.rows.filter(r => r.type === type).reduce((s, r) => s + (r[field] || 0), 0);
    // field: 'plannedUSDMonthly' | 'actualUSDMonthly'
  }
  function sumAll(field) {
    return state.rows.reduce((s, r) => s + (r[field] || 0), 0);
  }

  // Compute + render overview, charts, tips, report
  let chartMode = "pie"; // or 'bar'
  let chartCtx = els.chart.getContext("2d");

  function drawChartPie(targets, actuals) {
    const W = els.chart.width, H = els.chart.height;
    const ctx = chartCtx;
    ctx.clearRect(0,0,W,H);

    const labels = ["Needs","Wants","Savings"];
    const colors = ["#60a5fa","#f472b6","#34d399"];
    const centerX = W/2, centerY = H/2, radius = Math.min(W,H)/2 - 10;

    // Pie for actuals
    const totalA = actuals.reduce((a,b)=>a+b,0) || 1;
    let start = -Math.PI/2;
    actuals.forEach((val,i) => {
      const slice = (val/totalA) * Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, start, start + slice);
      ctx.closePath();
      ctx.fillStyle = colors[i];
      ctx.fill();
      start += slice;
    });

    // Legend + target bars
    ctx.font = "12px system-ui, sans-serif";
    labels.forEach((l,i) => {
      ctx.fillStyle = colors[i];
      ctx.fillRect(10, 10 + i*18, 12, 12);
      ctx.fillStyle = "#cbd5e1";
      ctx.fillText(`${l}`, 28, 20 + i*18);
    });

    // Target rings
    ctx.strokeStyle = "#64748b";
    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius+8, 0, Math.PI*2);
    ctx.stroke();
    // overlay target ticks (rough)
    const totalT = targets.reduce((a,b)=>a+b,0) || 1;
    let ang = -Math.PI/2;
    targets.forEach((val,i) => {
      const slice = (val/totalT) * Math.PI*2;
      ctx.beginPath();
      ctx.strokeStyle = colors[i];
      ctx.lineWidth = 6;
      ctx.arc(centerX, centerY, radius+8, ang, ang + slice);
      ctx.stroke();
      ang += slice;
    });
  }

  function drawChartBar(targets, actuals) {
    const W = els.chart.width, H = els.chart.height;
    const ctx = chartCtx;
    ctx.clearRect(0,0,W,H);

    const labels = ["Needs", "Wants", "Savings"];
    const colorsT = ["#93c5fd","#f9a8d4","#86efac"];
    const colorsA = ["#3b82f6","#ec4899","#22c55e"];
    const margin = { l: 32, r: 12, t: 10, b: 26 };
    const cw = (W - margin.l - margin.r) / labels.length;
    const barW = Math.min(40, cw/3);

    const maxVal = Math.max(...targets, ...actuals, 1);
    const yScale = (v) => (H - margin.b) - (v / maxVal) * (H - margin.t - margin.b);

    labels.forEach((lab, i) => {
      const x = margin.l + i * cw + cw/2;
      // Target
      ctx.fillStyle = colorsT[i];
      const yT = yScale(targets[i]);
      ctx.fillRect(x - barW - 3, yT, barW, (H - margin.b) - yT);
      // Actual
      ctx.fillStyle = colorsA[i];
      const yA = yScale(actuals[i]);
      ctx.fillRect(x + 3, yA, barW, (H - margin.b) - yA);
      // Label
      ctx.fillStyle = "#cbd5e1";
      ctx.font = "12px system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(lab, x, H - 8);
    });

    // Y axis ticks (0, 50%, 100%)
    ctx.strokeStyle = "#334155";
    ctx.lineWidth = 1;
    for (let k=0;k<=4;k++){
      const y = yScale(maxVal * (k/4));
      ctx.beginPath(); ctx.moveTo(margin.l, y); ctx.lineTo(W - margin.r, y); ctx.stroke();
      ctx.fillStyle = "#64748b"; ctx.textAlign = "right";
      ctx.fillText(k===0?fmt(0):fmt(fromUSD(maxVal * (k/4))), margin.l - 6, y + 4);
    }
  }

  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const rect = els.chart.getBoundingClientRect();
    els.chart.width = Math.floor(rect.width * dpr);
    els.chart.height = Math.floor(220 * dpr);
    chartCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", () => { resizeCanvas(); compute(); });
  els.toggleChart.addEventListener("click", () => {
    chartMode = chartMode === "pie" ? "bar" : "pie";
    compute();
  });

  function compute() {
    // Targets from income (USD monthly)
    const targets = getTargetsUSD();
    const pf = periodFactor();

    // Sums (USD monthly)
    const plannedUSDMonthly = sumAll("plannedUSDMonthly");
    const actualUSDMonthly = sumAll("actualUSDMonthly");

    // Per-type actuals (USD monthly)
    const needsAct = sumByType("Needs", "actualUSDMonthly");
    const wantsAct = sumByType("Wants", "actualUSDMonthly");
    const savingsAct = sumByType("Savings", "actualUSDMonthly");

    // Planned per-type could be used to compare within rows, but our key comparisons are targets vs actuals

    // Remaining
    const incomePeriodDisp = fromUSD(state.incomeUSDMonthly * pf);
    const plannedPeriodDisp = fromUSD(plannedUSDMonthly * pf);
    const actualPeriodDisp = fromUSD(actualUSDMonthly * pf);

    // Update Overview numbers
    els.incomeLabel.textContent = `Income (${state.period === "monthly" ? "Monthly" : "Annual"})`;
    els.incomeVal.textContent = fmt(incomePeriodDisp);
    els.plannedVal.textContent = fmt(plannedPeriodDisp);
    els.actualVal.textContent = fmt(actualPeriodDisp);

    const needsTargetDisp = fromUSD(targets.needsUSDMonthly * pf);
    const wantsTargetDisp = fromUSD(targets.wantsUSDMonthly * pf);
    const savingsTargetDisp = fromUSD(targets.savingsUSDMonthly * pf);

    els.needsTarget.textContent = fmt(needsTargetDisp);
    els.wantsTarget.textContent = fmt(wantsTargetDisp);
    els.savingsTarget.textContent = fmt(savingsTargetDisp);

    els.needsActual.textContent = fmt(fromUSD(needsAct * pf));
    els.wantsActual.textContent = fmt(fromUSD(wantsAct * pf));
    els.savingsActual.textContent = fmt(fromUSD(savingsAct * pf));

    const remainPlannedDisp = incomePeriodDisp - plannedPeriodDisp;
    const remainActualDisp = incomePeriodDisp - actualPeriodDisp;
    els.remainPlanned.textContent = fmt(remainPlannedDisp);
    els.remainActual.textContent = fmt(remainActualDisp);

    // Color codes
    colorize(els.remainPlanned, remainPlannedDisp);
    colorize(els.remainActual, remainActualDisp);

    // Savings rate (actual)
    const savingsRate = state.incomeUSDMonthly > 0 ? (100 * (savingsAct) / state.incomeUSDMonthly) : 0;
    els.savingsRate.textContent = state.incomeUSDMonthly > 0 ? savingsRate.toFixed(1) + "%" : "—";
    if (savingsRate >= 20) els.savingsRate.className = "value positive"; else if (savingsRate >= 10) els.savingsRate.className = "value warn"; else els.savingsRate.className = "value negative";

    // Charts
    resizeCanvas();
    const targetsArr = [targets.needsUSDMonthly, targets.wantsUSDMonthly, targets.savingsUSDMonthly].map(x => x * pf);
    const actualsArr = [needsAct, wantsAct, savingsAct].map(x => x * pf);
    if (chartMode === "pie") drawChartPie(targetsArr, actualsArr); else drawChartBar(targetsArr, actualsArr);

    // Report + Tips
    els.report.innerHTML = generateReportHTML(targets, { needsAct, wantsAct, savingsAct });
    els.tips.innerHTML = generateTipsHTML(targets, { needsAct, wantsAct, savingsAct });
  }

  function colorize(el, valueDisp) {
    el.classList.remove("positive","warn","negative");
    if (valueDisp > 0) el.classList.add("positive");
    else if (valueDisp === 0) el.classList.add("warn");
    else el.classList.add("negative");
  }

  function generateReportHTML(targets, actualsUSDMonthly) {
    const pf = periodFactor();
    const lines = [];
    const over = [];
    const under = [];

    const map = [
      { key: "Needs", t: targets.needsUSDMonthly, a: actualsUSDMonthly.needsAct },
      { key: "Wants", t: targets.wantsUSDMonthly, a: actualsUSDMonthly.wantsAct },
      { key: "Savings", t: targets.savingsUSDMonthly, a: actualsUSDMonthly.savingsAct },
    ];
    for (const m of map) {
      const diff = m.a - m.t;
      const diffDisp = fmt(fromUSD(diff * pf));
      const tDisp = fmt(fromUSD(m.t * pf));
      const aDisp = fmt(fromUSD(m.a * pf));
      const status = diff > 0 ? "Over" : (diff < 0 ? "Under" : "On target");
      lines.push(`${m.key}: Target ${tDisp} | Actual ${aDisp} | ${status} ${diff > 0 ? "+" : ""}${diffDisp}`);
      if (diff > 0) over.push(m.key);
      if (diff < 0) under.push(m.key);
    }

    const savingsProgress = actualsUSDMonthly.savingsAct / Math.max(1, targets.savingsUSDMonthly);
    const progressPct = Math.round(savingsProgress * 100);
    lines.push("");
    lines.push(`Savings progress vs target: ${isFinite(progressPct) ? progressPct : 0}%`);

    const overs = over.length ? `Overspending: ${over.join(", ")}.` : "No overspending vs targets.";
    const unders = under.length ? `Under target: ${under.join(", ")}.` : "All categories at or above target.";
    lines.push(overs);
    lines.push(unders);

    return lines.map(l => `<div>${l}</div>`).join("");
  }

  function generateReportLines() {
    const pf = periodFactor();
    const t = getTargetsUSD();
    const needsAct = sumByType("Needs","actualUSDMonthly");
    const wantsAct = sumByType("Wants","actualUSDMonthly");
    const savingsAct = sumByType("Savings","actualUSDMonthly");
    const map = [
      { key:"Needs", t: t.needsUSDMonthly, a: needsAct },
      { key:"Wants", t: t.wantsUSDMonthly, a: wantsAct },
      { key:"Savings", t: t.savingsUSDMonthly, a: savingsAct },
    ];
    const out = [];
    for (const m of map) {
      const diff = m.a - m.t;
      out.push(`${m.key}: Target ${fmt(fromUSD(m.t*pf))} | Actual ${fmt(fromUSD(m.a*pf))} | ${diff>=0?"+":""}${fmt(fromUSD(diff*pf))}`);
    }
    return out;
  }

  function generateTipsHTML(targets, actualsUSDMonthly) {
    const pf = periodFactor();
    const tips = [];
    // Basic guidance
    if (actualsUSDMonthly.needsAct > 0.55 * state.incomeUSDMonthly) {
      tips.push("Needs exceed 55% of income. Consider negotiating rent, finding cheaper plans, or reducing fixed costs.");
    }
    if (actualsUSDMonthly.wantsAct > 0.35 * state.incomeUSDMonthly) {
      tips.push("Wants exceed 35% of income. Try no-spend days, swap paid entertainment for free options, or set weekly caps.");
    }
    if (actualsUSDMonthly.savingsAct < 0.10 * state.incomeUSDMonthly) {
      tips.push("Savings below 10%. Automate transfers on payday and aim to increase by 1–2% each month.");
    }
    // Over vs target specifics
    const deltas = [
      { key: "Needs", d: actualsUSDMonthly.needsAct - targets.needsUSDMonthly },
      { key: "Wants", d: actualsUSDMonthly.wantsAct - targets.wantsUSDMonthly },
      { key: "Savings", d: actualsUSDMonthly.savingsAct - targets.savingsUSDMonthly },
    ];
    deltas.forEach(x => {
      const amt = Math.abs(x.d);
      if (amt > 0.05 * state.incomeUSDMonthly) {
        const dir = x.d > 0 ? "over" : "under";
        const msg = x.key === "Savings"
          ? (dir === "under"
              ? `Boost Savings by ~${fmt(fromUSD(amt * pf))}. Consider splitting windfalls (e.g., 50% to savings).`
              : `Great job: Savings exceed target by ${fmt(fromUSD(amt * pf))}. Keep an emergency buffer.`)
          : `${x.key} are ${dir} target by ${fmt(fromUSD(amt * pf))}. Review subscriptions and recurring expenses.`;
        tips.push(msg);
      }
    });
    if (!tips.length) tips.push("You're close to 50/30/20 targets. Keep tracking and adjusting weekly.");
    return tips.map(t => `<div>• ${t}</div>`).join("");
  }

  // Init with example rows if empty
  if (!state.rows.length) {
    state.rows = [
      { id: "r1", name: "Housing (Rent)", type: "Needs", plannedUSDMonthly: 1200, actualUSDMonthly: 1200 },
      { id: "r2", name: "Groceries", type: "Needs", plannedUSDMonthly: 400, actualUSDMonthly: 420 },
      { id: "r3", name: "Transport", type: "Needs", plannedUSDMonthly: 220, actualUSDMonthly: 180 },
      { id: "r4", name: "Entertainment", type: "Wants", plannedUSDMonthly: 200, actualUSDMonthly: 260 },
      { id: "r5", name: "Dining Out", type: "Wants", plannedUSDMonthly: 150, actualUSDMonthly: 180 },
      { id: "r6", name: "Savings/Investments", type: "Savings", plannedUSDMonthly: 500, actualUSDMonthly: 500 },
    ];
  }

  // Render
  renderRows();
  renderGoals();
  syncCurrencyUI();
  // Income field initial render
  (function initIncomeField(){
    const disp = fromUSD(state.incomeUSDMonthly * periodFactor());
    els.income.value = Math.round(disp);
    els.periodPill.textContent = state.period === "monthly" ? "Monthly" : "Annual";
    els.currency.value = state.currency;
  })();

  // FX refresh on load and hourly + on visibility
  updateFX();
  setInterval(updateFX, 60*60*1000);
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") updateFX();
  });

  // Initial compute
  compute();
})();
</script>
</body>
</html>
